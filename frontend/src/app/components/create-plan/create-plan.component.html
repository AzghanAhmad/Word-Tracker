<div class="create-plan-redesign">
    <!-- Header -->
    <header class="plan-header">
        <div class="title-section">
            <h1 *ngIf="!planName">Edit me: A Brand New Goal!</h1>
            <h1 *ngIf="planName">{{ planName }}</h1>
            <p class="subtitle">{{ contentType }} Drafting</p>
        </div>
        <div class="header-actions">
            <button class="btn-done" (click)="cancel()">
                <i class="fas fa-chart-bar"></i> Done Editing
            </button>
            <button class="btn-save" (click)="savePlan()" [disabled]="isLoading">
                <i class="fas" [ngClass]="isLoading ? 'fa-spinner fa-spin' : 'fa-save'"></i> {{ isLoading ? 'Saving...'
                : 'Save' }}
            </button>
            <div class="share-dropdown">
                <button class="btn-share" (click)="toggleShareDropdown()">
                    Share <i class="fas fa-caret-down"></i>
                </button>
                <div class="share-menu" *ngIf="showShareDropdown">
                    <button (click)="copyPlanLink()" class="share-option">
                        <i class="fas fa-link"></i> Copy Link
                    </button>
                    <button (click)="shareToTwitter()" class="share-option">
                        <i class="fab fa-twitter"></i> Share to Twitter
                    </button>
                    <button (click)="shareToFacebook()" class="share-option">
                        <i class="fab fa-facebook"></i> Share to Facebook
                    </button>
                    <div class="share-divider"></div>
                    <button (click)="togglePlanVisibility()" class="share-option">
                        <i class="fas" [ngClass]="isPrivate ? 'fa-lock' : 'fa-globe'"></i>
                        {{ isPrivate ? 'Make Public' : 'Make Private' }}
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs Navigation -->
    <nav class="plan-tabs">
        <button [class.active]="viewMode === 'schedule'" (click)="viewMode = 'schedule'">Schedule</button>
        <button [class.active]="viewMode === 'progress'" (click)="viewMode = 'progress'">Progress</button>
        <button [class.active]="viewMode === 'stats'" (click)="viewMode = 'stats'">Stats</button>
    </nav>

    <div class="plan-content">
        <!-- Sidebar -->
        <aside class="plan-sidebar">
            <div class="sidebar-card">
                <div class="card-header">
                    <span>Plan Info</span>
                    <i class="fas fa-arrows-alt-v"></i>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" placeholder="e.g. November Nanowrimo Novel" [(ngModel)]="planName">
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Target word count :</label>
                            <input type="number" [(ngModel)]="targetWordCount" (ngModelChange)="onTargetChange()">
                        </div>
                        <div class="form-group half">
                            <label>Content type :</label>
                            <select [(ngModel)]="contentType">
                                <option value="Novella">Novella</option>
                                <option value="Novel">Novel</option>
                                <option value="Epic">Epic</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Start Date :</label>
                            <input type="date" [(ngModel)]="startDate" (change)="onDateChange()">
                        </div>
                        <div class="form-group half">
                            <label>End Date :</label>
                            <input type="date" [(ngModel)]="endDate" (change)="onDateChange()">
                        </div>
                    </div>
                    <div class="project-org">
                        <label>Project Organization</label>
                        <p class="hint">Save this plan before adding to a project</p>
                    </div>
                </div>
            </div>

            <!-- Plan Description -->
            <div class="sidebar-card">
                <div class="card-header">
                    <h3>Plan Description</h3>
                    <i class="fas fa-arrows-alt-v"></i>
                </div>
                <div class="card-body">
                    <div class="privacy-toggle">
                        <i class="fas fa-lock"></i>
                        <input type="checkbox" [(ngModel)]="isPrivate">
                        <span>Make this plan private</span>
                    </div>
                    <div class="description-stats" [class.over-limit]="isDescriptionOverLimit()">
                        <span [class.text-warning]="isDescriptionOverLimit()">
                            {{ getDescriptionWordCount() }} words / <b>Max {{ maxDescriptionWords }} words</b>
                        </span>
                    </div>
                    <textarea #descriptionInput [(ngModel)]="planDescription" placeholder="Enter a description"
                        [class.over-limit]="isDescriptionOverLimit()"></textarea>
                </div>
            </div>

            <!-- Goals Section -->
            <div class="sidebar-card">
                <div class="card-header">
                    <h3>Goals</h3>
                    <i class="fas fa-arrows-alt-v"></i>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Starting Point <i class="fas fa-info-circle"></i></label>
                            <input type="number" [(ngModel)]="startingPoint">
                        </div>
                        <div class="form-group half">
                            <label>Target</label>
                            <input type="number" [(ngModel)]="targetWordCount">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>How It's Measured</label>
                        <select [(ngModel)]="measurementUnit">
                            <option value="words">words</option>
                            <option value="pages">pages</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Is this an overall goal or a daily target : <i class="fas fa-info-circle"></i></label>
                        <div class="radio-group">
                            <label><input type="radio" [value]="false" [(ngModel)]="isDailyTarget"> Overall
                                Target</label>
                            <label><input type="radio" [value]="true" [(ngModel)]="isDailyTarget"> Daily</label>
                        </div>
                    </div>
                    <div class="date-info">
                        <span>Your Start Date: {{ formatDate(startDate) || 'Not set' }}</span>
                    </div>
                    <div class="form-group">
                        <label>Fixed deadline?</label>
                        <div class="radio-group">
                            <label><input type="radio" [value]="true" [(ngModel)]="fixedDeadline"
                                    (change)="onFixedDeadlineChange()"> Yes</label>
                            <label><input type="radio" [value]="false" [(ngModel)]="fixedDeadline"
                                    (change)="onFixedDeadlineChange()"> No</label>
                        </div>
                    </div>
                    <div class="form-group" *ngIf="fixedDeadline">
                        <label>Target Finish Date</label>
                        <input type="date" [(ngModel)]="targetFinishDate" (change)="onTargetFinishDateChange()">
                    </div>
                    <div class="date-info" *ngIf="!fixedDeadline && targetFinishDate">
                        <span>Target Finish Date: {{ formatDate(targetFinishDate) }}</span>
                    </div>
                </div>
            </div>






            <!-- Display Settings -->
            <div class="sidebar-card">
                <div class="card-header">
                    <h3>Display Settings</h3>
                    <i class="fas fa-arrows-alt-v"></i>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Dashboard Color</label>
                        <div class="color-picker-row">
                            <input type="color" [(ngModel)]="dashboardColor" class="dashboard-color-input">
                            <span>{{ dashboardColor }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="sidebar-card">
                <div class="card-header">
                    <h3>Progress</h3>
                    <i class="fas fa-arrows-alt-v"></i>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Manual Progress (%)</label>
                        <input type="number" [(ngModel)]="currentProgress"
                            (ngModelChange)="onManualProgressChange($event)" min="0" max="100" placeholder="0 - 100">
                        <p class="hint mt-1">Enter a number 1-100 to update plan progress.</p>
                    </div>
                </div>
            </div>

        </aside>

        <!-- Main Content -->
        <main class="plan-main">
            <!-- Schedule/Stats View -->
            <div *ngIf="viewMode === 'schedule'">
                <div class="schedule-summary">
                    <div class="word-badge">
                        <span class="count">{{ targetWordCount | number }} words</span>
                        &nbsp;<span class="label">over</span>&nbsp;
                        <span class="days">{{ totalDays }} days</span>
                    </div>
                    <div class="timeline">
                        <span class="date">{{ startDate | date:'MM/dd/yyyy' }}</span>
                        <div class="line">
                            <span class="days-left">{{ daysLeft }} days left</span>
                        </div>
                        <span class="date">{{ endDate | date:'MM/dd/yyyy' }}</span>
                    </div>
                </div>

                <div [ngSwitch]="displayViewType">
                    <!-- Table View -->
                    <div *ngSwitchCase="'Table'" class="view-card table-view">
                        <table class="plan-table">
                            <thead>
                                <tr>
                                    <th>Num</th>
                                    <th>Day</th>
                                    <th>Date</th>
                                    <th>Work to Complete</th>
                                    <th>Actual Work Done</th>
                                    <th>Expected Progress</th>
                                    <th>Work Left</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let day of planDays">
                                    <td>{{ day.num }}</td>
                                    <td>{{ day.day }}</td>
                                    <td>{{ day.date }}</td>
                                    <td><b>{{ day.workToComplete | number }}</b></td>
                                    <td>
                                        <input type="number" [(ngModel)]="day.actualWorkDone"
                                            (ngModelChange)="onTableProgressChange(day)" class="table-input"
                                            placeholder="0">
                                    </td>
                                    <td>{{ day.expectedProgress | number }}</td>
                                    <td>{{ day.workLeft | number }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Calendar View -->
                    <div *ngSwitchCase="'Calendar'" class="view-card calendar-view">
                        <div class="calendar-header">
                            <h2>{{ startDate | date:'MMMM' }}</h2>
                        </div>
                        <div class="calendar-grid">
                            <div class="day-label">Monday</div>
                            <div class="day-label">Tuesday</div>
                            <div class="day-label">Wednesday</div>
                            <div class="day-label">Thursday</div>
                            <div class="day-label">Friday</div>
                            <div class="day-label">Saturday</div>
                            <div class="day-label">Sunday</div>

                            <div *ngFor="let day of planDays" class="day-cell">
                                <span class="date-num">{{ day.dateObj | date:'dd' }}</span>
                                <div class="word-bubble" [style.background]="dashboardColor">
                                    {{ day.workToComplete | number }} words
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Graph View -->
                    <div *ngSwitchCase="'Graph'" class="view-card graph-view">
                        <div class="chart-container">
                            <h3 class="chart-title">Daily Work</h3>
                            <div class="svg-container">
                                <svg viewBox="0 0 800 200" preserveAspectRatio="none" class="chart-svg">
                                    <!-- Grid Lines -->
                                    <line *ngFor="let line of getGridLines(getMaxDailyTarget())" x1="0"
                                        [attr.y1]="getYPos(line, getMaxDailyTarget())" x2="800"
                                        [attr.y2]="getYPos(line, getMaxDailyTarget())" class="grid-line"></line>

                                    <path [attr.d]="getLinePath()" fill="none" class="target-path"></path>

                                    <!-- Data Dots -->
                                    <circle *ngFor="let pt of getDailyPoints()" [attr.cx]="pt.x" [attr.cy]="pt.y" r="4"
                                        class="data-dot" (mouseenter)="hoveredDay = pt.day"
                                        (mouseleave)="hoveredDay = null"></circle>
                                </svg>

                                <div class="chart-axes">
                                    <div class="y-axis">
                                        <span *ngFor="let line of getGridLines(getMaxDailyTarget()).reverse()"
                                            class="axis-label">{{ line | number:'1.0-1' }}</span>
                                    </div>
                                    <div class="x-axis">
                                        <ng-container *ngFor="let day of planDays; let i = index">
                                            <span *ngIf="i % (totalDays > 10 ? 3 : 1) === 0" class="axis-label">{{
                                                day.dateObj
                                                | date:'yyyy-MM-dd' }}</span>
                                        </ng-container>
                                    </div>
                                </div>

                                <!-- Tooltip Popover -->
                                <div *ngIf="hoveredDay" class="chart-tooltip"
                                    [style.left.px]="(planDays.indexOf(hoveredDay) * (800 / (planDays.length - 1 || 1))) - 60"
                                    [style.bottom.px]="150">
                                    <div class="tooltip-header">{{ hoveredDay.dateObj | date:'MM/dd/yyyy' }}</div>
                                    <div class="tooltip-row green">Work you logged on this day: -</div>
                                    <div class="tooltip-row blue">Target Quota For This Day: {{
                                        hoveredDay.workToComplete }}</div>
                                </div>
                            </div>
                            <div class="legend">
                                <span class="dot target"></span> Target Daily
                            </div>
                        </div>

                        <div class="chart-container mt-8">
                            <h3 class="chart-title">Overall Progress</h3>
                            <div class="svg-container">
                                <svg viewBox="0 0 800 200" preserveAspectRatio="none" class="chart-svg">
                                    <!-- Grid Lines -->
                                    <line *ngFor="let line of getGridLines(targetWordCount)" x1="0"
                                        [attr.y1]="getYPos(line, targetWordCount)" x2="800"
                                        [attr.y2]="getYPos(line, targetWordCount)" class="grid-line"></line>

                                    <path [attr.d]="getCumulativePath()" fill="none" class="progress-path"></path>

                                    <!-- Data Dots -->
                                    <circle *ngFor="let pt of getCumulativePoints()" [attr.cx]="pt.x" [attr.cy]="pt.y"
                                        r="4" class="data-dot" (mouseenter)="hoveredDay = pt.day"
                                        (mouseleave)="hoveredDay = null"></circle>
                                </svg>

                                <div class="chart-axes">
                                    <div class="y-axis">
                                        <span *ngFor="let line of getGridLines(targetWordCount).reverse()"
                                            class="axis-label">{{ line | number:'1.0-1' }}</span>
                                    </div>
                                    <div class="x-axis">
                                        <ng-container *ngFor="let day of planDays; let i = index">
                                            <span *ngIf="i % (totalDays > 10 ? 3 : 1) === 0" class="axis-label">{{
                                                day.dateObj
                                                | date:'yyyy-MM-dd' }}</span>
                                        </ng-container>
                                    </div>
                                </div>
                            </div>
                            <div class="legend">
                                <span class="dot progress"></span> Cumulative Progress
                            </div>
                        </div>
                    </div>

                    <!-- Bar View -->
                    <div *ngSwitchCase="'Bar'" class="view-card bar-view">
                        <div class="chart-container">
                            <h3>Daily Workload</h3>
                            <div class="bar-chart">
                                <div *ngFor="let day of planDays" class="bar-wrapper"
                                    [title]="day.date + ': ' + day.workToComplete + ' words'">
                                    <div class="bar" [style.height.%]="(day.workToComplete / getMaxDailyTarget()) * 100"
                                        [style.background]="dashboardColor"></div>
                                    <span class="bar-label">{{ day.num }}</span>
                                </div>
                            </div>
                            <div class="chart-axes">
                                <div class="y-axis">
                                    <span>{{ getMaxDailyTarget() | number }}</span>
                                    <span>{{ (getMaxDailyTarget() / 2) | number }}</span>
                                    <span>0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Tab View -->
            <div *ngIf="viewMode === 'progress'" class="progress-view-content">
                <div class="progress-overview-banner">
                    <div class="overview-left">
                        <h2>Overall Completion</h2>
                        <div class="big-progress-container">
                            <div class="progress-info">
                                <span class="percent-text">{{ currentProgress }}%</span>
                                <span class="words-text">{{ totalWordsLogged | number }} / {{ targetWordCount | number
                                    }} words</span>
                            </div>
                            <div class="big-progress-bar">
                                <div class="fill" [style.width.%]="currentProgress"></div>
                            </div>
                        </div>
                    </div>
                    <div class="overview-right">
                        <!-- <button class="btn-save-progress" (click)="saveProgress()">
                            <i class="fas fa-save"></i> Back up to cloud
                        </button> -->
                    </div>
                </div>

            </div>

            <!-- Stats Tab View -->
            <div *ngIf="viewMode === 'stats'" class="stats-view-content">
                <div class="stats-dashboard-grid">
                    <!-- Main Gauge Card -->
                    <div class="stats-main-card">
                        <div class="gauge-container">
                            <svg viewBox="0 0 100 100" class="on-track-gauge">
                                <circle cx="50" cy="50" r="45" class="gauge-bg"></circle>
                                <circle cx="50" cy="50" r="45" class="gauge-fill"
                                    [style.strokeDashoffset]="getOnTrackStroke()"></circle>
                            </svg>
                            <div class="gauge-center">
                                <span class="gauge-value">{{ currentProgress }}%</span>
                                <span class="gauge-label">Completion</span>
                            </div>
                        </div>
                        <div class="gauge-details">
                            <h3>Goal Status</h3>
                            <p class="status-badge" [ngClass]="{
                                'ahead': onTrackStatus === 'Ahead of Schedule',
                                'on-track': onTrackStatus === 'On Track',
                                'behind': onTrackStatus === 'Behind Schedule'
                            }">{{ onTrackStatus }}</p>
                            <p *ngIf="onTrackPercent >= 100">You are exceeding your goals! Keep the momentum.</p>
                            <p *ngIf="onTrackPercent < 100 && onTrackPercent >= 80">You're slightly behind, but well
                                within reach.</p>
                            <p *ngIf="onTrackPercent < 80">Time to pick up the pace to hit your deadline.</p>
                            <div class="streak-mini-badge">
                                <i class="fas fa-fire"></i> {{ currentStreak }} Day Streak
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Quick Stats -->
                    <div class="stats-quick-grid">
                        <div class="quick-stat-tile">
                            <div class="icon-box blue"><i class="fas fa-pen-nib"></i></div>
                            <div class="tile-info">
                                <span class="label">Total Words</span>
                                <span class="value">{{ totalWordsLogged | number }}</span>
                            </div>
                        </div>
                        <div class="quick-stat-tile">
                            <div class="icon-box green"><i class="fas fa-check-circle"></i></div>
                            <div class="tile-info">
                                <span class="label">Words Left</span>
                                <span class="value">{{ wordsRemaining | number }}</span>
                            </div>
                        </div>
                        <div class="quick-stat-tile">
                            <div class="icon-box purple"><i class="fas fa-trophy"></i></div>
                            <div class="tile-info" *ngIf="bestDay">
                                <span class="label">Best Session</span>
                                <span class="value">{{ bestDay.count | number }}</span>
                                <span class="sub-label">{{ bestDay.date }}</span>
                            </div>
                        </div>
                        <div class="quick-stat-tile">
                            <div class="icon-box orange"><i class="fas fa-stopwatch"></i></div>
                            <div class="tile-info">
                                <span class="label">Plan Days</span>
                                <span class="value">{{ totalDays }}</span>
                                <span class="sub-label">{{ daysLeft }} remaining</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Chart -->
                <div class="stats-activity-chart-section">
                    <h3>Recent Activity</h3>
                    <div class="chart-container">
                        <div class="bar-chart">
                            <div *ngFor="let item of recentActivity" class="chart-column">
                                <div class="bar-container">
                                    <div class="bar-fill" [style.height.%]="item.height"
                                        [title]="item.count + ' words'">
                                        <span class="bar-value" *ngIf="item.height > 15">{{ item.count | number
                                            }}</span>
                                    </div>
                                </div>
                                <div class="column-label">{{ item.day }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-averages-section">
                    <h3>Writing Efficiency</h3>
                    <div class="averages-grid">
                        <div class="avg-card">
                            <label>Overall Daily Average</label>
                            <div class="avg-value">{{ dailyAvg | number }} <span>words/day</span></div>
                        </div>
                        <div class="avg-card">
                            <label>Weekly Target</label>
                            <div class="avg-value">{{ weeklyAvg | number }} <span>words/week</span></div>
                        </div>
                        <div class="avg-card">
                            <label>Weekdays</label>
                            <div class="avg-value">{{ weekdayAvg | number }} <span>avg words</span></div>
                        </div>
                        <div class="avg-card">
                            <label>Weekends</label>
                            <div class="avg-value">{{ weekendAvg | number }} <span>avg words</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>